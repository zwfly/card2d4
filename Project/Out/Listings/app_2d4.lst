C51 COMPILER V9.56.0.0   APP_2D4                                                           11/11/2017 19:30:51 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE APP_2D4
OBJECT MODULE PLACED IN .\Out\Objects\app_2d4.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\App\src\app_2d4.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Common\inc
                    -;..\App\inc;..\Bsp\inc;..\Startup;..\Bsp) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\Out\Listings\app_2d4.lst) OBJEC
                    -T(.\Out\Objects\app_2d4.obj)

line level    source

   1          /*
   2           * app_2d4.c
   3           *
   4           *  Created on: 2017年8月16日
   5           *      Author: fly
   6           */
   7          #include "app.h"
   8          #include <string.h>
   9          #include <ctype.h>
  10          
  11          #include "app_2d4.h"
  12          
  13          static uint8_t sendRcv_flag = 0; //0 rcv， 1 send
  14          static uint8_t rcvBuf[PAYLOAD_WIDTH] = { 0 };
  15          uint8_t sendBuf[PAYLOAD_WIDTH] = { 0 };
  16          
  17          uint8_t tmpBuf[8] = { 0 };
  18          
  19          //static uint8_t test_vol = 0;
  20          //static uint8_t test_yinxiang_status = 0;
  21          
  22          void app_2d4_init(void) {
  23   1      
  24   1              sendRcv_flag = 0;
  25   1              memset(rcvBuf, 0, sizeof(rcvBuf));
  26   1              memset(sendBuf, 0, sizeof(sendBuf));
  27   1      
  28   1              RF_Init();
  29   1      #if 1
  30   1      
  31   1              RF_RxMode();
  32   1      #else
                      RF_TxMode();
                      sendRcv_flag = 1;
              #endif
  36   1      
  37   1      //      RF_Carrier(1);
  38   1      
  39   1      }
  40          
  41          void app_2d4_send(uint8_t *d, uint8_t len) {
  42   1      //      if (len > PAYLOAD_WIDTH) {
  43   1      //              return;
  44   1      //      }
  45   1              uint8_t i = 0;
  46   1              for (i = 0; i < 10; i++) {
  47   2                      nop
  48   2      //              nop
  49   2      //              nop
  50   2      //              nop
  51   2              }
  52   1              RF_TxMode();
  53   1              sendRcv_flag = 1;
C51 COMPILER V9.56.0.0   APP_2D4                                                           11/11/2017 19:30:51 PAGE 2   

  54   1      
  55   1              for (i = 0; i < 10; i++) {
  56   2                      nop
  57   2      //              nop
  58   2      //              nop
  59   2      //              nop
  60   2              }
  61   1      
  62   1              if (sendBuf != d) {
  63   2                      memset(sendBuf, 0, PAYLOAD_WIDTH);
  64   2                      memcpy(sendBuf, d, len);
  65   2              }
  66   1      }
  67          #if DEBUG
              idata char sss[32] = {0};
              #endif
  70          static void app_2d4_Rcv(uint8_t *buf) {
  71   1              uint8_t tmp = 0;
  72   1              uint8_t i = 0;
  73   1              uint8_t index = 0;
  74   1              uint8_t check = 0;
  75   1      #if DEBUG
                      sprintf(sss, "rcv %02X %02X %02X %02X %02X %02X\r\n", (uint16_t) buf[0],
                                      (uint16_t) buf[1], (uint16_t) buf[2], (uint16_t) buf[3],
                                      (uint16_t) buf[4], (uint16_t) buf[5]);
                      printf(sss);
              #endif
  81   1              if (buf[0] != LCD2LAMP_HEADER) {
  82   2                      return;
  83   2              }
  84   1              if (buf[1] > sizeof(rcvBuf)) {
  85   2                      return;
  86   2              }
  87   1              for (i = 0; i < (buf[1] + 1); i++) {
  88   2                      check += buf[i + 1];
  89   2              }
  90   1              if (check != buf[buf[1] + 2]) {
  91   2                      return;
  92   2              }
  93   1      
  94   1              memset(sendBuf, 0, PAYLOAD_WIDTH);
  95   1              index = 0;
  96   1              switch (buf[2]) {
  97   2              case KEY_POWER_SHORT_CMD:
  98   2                      if (g_tWork.status.bits.DOME) {
  99   3                              if (g_tWork.status.bits.pause) {
 100   4                                      g_tWork.status.bits.pause = 0;
 101   4                                      app_dome_start_current();
 102   4                              } else {
 103   4                                      g_tWork.status.bits.pause = 1;
 104   4                                      app_dome_stop_current();
 105   4                              }
 106   3                              sendBuf[index++] = LAMP2LCD_HEADER;
 107   3                              sendBuf[index++] = 10;
 108   3                              sendBuf[index++] = KEY_POWER_SHORT_CMD;
 109   3      //                      sendBuf[index++] = 0x05;
 110   3                              sendBuf[index++] = g_tWork.status.bits.pause;
 111   3                              app_dome_get_current_Name(sendBuf + index, 8);
 112   3                              index += 8;
 113   3                              for (i = 0; i < (sendBuf[1] + 1); i++) {
 114   4                                      sendBuf[index] += sendBuf[i + 1];
 115   4                              }
C51 COMPILER V9.56.0.0   APP_2D4                                                           11/11/2017 19:30:51 PAGE 3   

 116   3                              index++;
 117   3                              app_2d4_send(sendBuf, index);
 118   3      
 119   3                      } else {
 120   3                              app_uart_send(KEY_POWER_SHORT_CMD, 0, 0);
 121   3                      }
 122   2      
 123   2      #if 0
                              if (g_tWork.status.bits.DOME) {
                                      g_tWork.status.bits.DOME = 0;
              
                                      sendBuf[index++] = LAMP2LCD_HEADER;
                                      sendBuf[index++] = 11;
                                      sendBuf[index++] = KEY_POWER_SHORT_CMD;
                                      sendBuf[index++] = g_tWork.status.bits.DOME;
                                      sendBuf[index++] = g_tWork.status.bits.pause;
                                      app_dome_get_current_Name(sendBuf + index, 8);
                                      index += 8;
                                      for (i = 0; i < (sendBuf[1] + 1); i++) {
                                              sendBuf[index] += sendBuf[i + 1];
                                      }
                                      index++;
                                      app_2d4_send(sendBuf, index);
                              } else {
                                      app_uart_send(KEY_POWER_SHORT_CMD, 0, 0);
                              }
              #endif
 143   2                      break;
 144   2      #if 0
                              case POWER_LONG_CMD:
              #if 0
                              if (buf[3] == 1) {
                                      test_yinxiang_status = 1;
                              } else if (buf[3] == 2) {
                                      test_yinxiang_status = 0;
                              } else if (buf[3] == 3) {
                                      if (test_yinxiang_status) {
                                              test_yinxiang_status = 0;
                                      } else {
                                              test_yinxiang_status = 1;
                                      }
                              }
                              sendBuf[index++] = LAMP2LCD_HEADER;
                              sendBuf[index++] = 0x02;
                              sendBuf[index++] = buf[2];
                              sendBuf[index++] = test_yinxiang_status;
                              for (i = 0; i < (sendBuf[1] + 1); i++) {
                                      sendBuf[index] += sendBuf[i + 1];
                              }
              #else
                              //      tmp = 0x03;
                              //      app_uart_send(POWER_LONG_UART_CMD, &tmp, 1);
              
              #endif
                              break;
              #endif
 172   2              case KEY_ACC_CMD:
 173   2                      if (buf[3] == 1) {
 174   3                              Relay_on();
 175   3                      } else if (buf[3] == 2) {
 176   3                              Relay_off();
 177   3                      } else if (buf[3] == 3) {
C51 COMPILER V9.56.0.0   APP_2D4                                                           11/11/2017 19:30:51 PAGE 4   

 178   3                              Relay_toggle();
 179   3                      }
 180   2                      sendBuf[index++] = LAMP2LCD_HEADER;
 181   2                      sendBuf[index++] = 0x02;
 182   2                      sendBuf[index++] = buf[2];
 183   2                      if (Relay_IsOn()) {
 184   3                              sendBuf[index++] = 0x01;
 185   3                      } else {
 186   3                              sendBuf[index++] = 0x02;
 187   3                      }
 188   2                      for (i = 0; i < (sendBuf[1] + 1); i++) {
 189   3                              sendBuf[index] += sendBuf[i + 1];
 190   3                      }
 191   2                      break;
 192   2              case KEY_UP_CMD:
 193   2                      if (g_tWork.status.bits.DOME) {
 194   3                              if (g_tWork.status.bits.pause == 0) {
 195   4                                      app_dome_previous();
 196   4                                      sendBuf[index++] = LAMP2LCD_HEADER;
 197   4                                      sendBuf[index++] = 9;
 198   4                                      sendBuf[index++] = KEY_UP_CMD;
 199   4      //                              sendBuf[index++] = 0x05;
 200   4                                      app_dome_get_current_Name(sendBuf + index, 8);
 201   4                                      index += 8;
 202   4                                      for (i = 0; i < (sendBuf[1] + 1); i++) {
 203   5                                              sendBuf[index] += sendBuf[i + 1];
 204   5                                      }
 205   4                                      index++;
 206   4                                      app_2d4_send(sendBuf, index);
 207   4                              }
 208   3                      } else {
 209   3                              app_uart_send(KEY_UP_CMD, 0, 0);
 210   3                      }
 211   2                      break;
 212   2              case KEY_DOWN_CMD:
 213   2                      if (g_tWork.status.bits.DOME) {
 214   3                              if (g_tWork.status.bits.pause == 0) {
 215   4                                      app_dome_next();
 216   4                                      sendBuf[index++] = LAMP2LCD_HEADER;
 217   4                                      sendBuf[index++] = 9;
 218   4                                      sendBuf[index++] = KEY_DOWN_CMD;
 219   4      //                              sendBuf[index++] = 0x05;
 220   4                                      app_dome_get_current_Name(sendBuf + index, 8);
 221   4                                      index += 8;
 222   4                                      for (i = 0; i < (sendBuf[1] + 1); i++) {
 223   5                                              sendBuf[index] += sendBuf[i + 1];
 224   5                                      }
 225   4                                      index++;
 226   4                                      app_2d4_send(sendBuf, index);
 227   4                              }
 228   3                      } else {
 229   3                              app_uart_send(KEY_DOWN_CMD, 0, 0);
 230   3                      }
 231   2                      break;
 232   2              case RCV_PREV_NEXT_CMD:
 233   2      
 234   2                      break;
 235   2              case KEY_DOME_CMD:
 236   2      
 237   2      //              tmp = 0x03;
 238   2      //              app_uart_send(DOME_UART_CMD, &tmp, 1);
 239   2      
C51 COMPILER V9.56.0.0   APP_2D4                                                           11/11/2017 19:30:51 PAGE 5   

 240   2                      if (g_tWork.status.bits.DOME) {
 241   3                              g_tWork.status.bits.DOME = 0;
 242   3                      } else {
 243   3                              g_tWork.status.bits.DOME = 1;
 244   3                      }
 245   2                      sendBuf[index++] = LAMP2LCD_HEADER;
 246   2                      sendBuf[index++] = 11;
 247   2                      sendBuf[index++] = KEY_DOME_CMD;
 248   2                      sendBuf[index++] = g_tWork.status.bits.DOME;
 249   2                      sendBuf[index++] = g_tWork.status.bits.pause;
 250   2                      app_dome_get_current_Name(sendBuf + index, 8);
 251   2                      index += 8;
 252   2                      for (i = 0; i < (sendBuf[1] + 1); i++) {
 253   3                              sendBuf[index] += sendBuf[i + 1];
 254   3                      }
 255   2                      index++;
 256   2                      app_2d4_send(sendBuf, index);
 257   2      
 258   2                      break;
 259   2              case KEY_VOL_ADD_CMD:
 260   2      #if 0
                              if (buf[3] == 1) {
                                      test_vol++;
                                      if (test_vol > 30) {
                                              test_vol = 30;
                                      }
                              } else if (buf[3] == 2) {
                                      if (test_vol) {
                                              test_vol--;
                                      }
                              }
              
                              sendBuf[index++] = LAMP2LCD_HEADER;
                              sendBuf[index++] = 0x02;
                              sendBuf[index++] = buf[2];
                              sendBuf[index++] = test_vol;
                              for (i = 0; i < (sendBuf[1] + 1); i++) {
                                      sendBuf[index] += sendBuf[i + 1];
                              }
              
              #else
 281   2                      app_uart_send(KEY_VOL_ADD_CMD, 0, 0);
 282   2      #endif
 283   2                      break;
 284   2              case KEY_VOL_MINUS_CMD:
 285   2      #if 0
                              if (buf[3] == 1) {
                                      test_vol++;
                                      if (test_vol > 30) {
                                              test_vol = 30;
                                      }
                              } else if (buf[3] == 2) {
                                      if (test_vol) {
                                              test_vol--;
                                      }
                              }
              
                              sendBuf[index++] = LAMP2LCD_HEADER;
                              sendBuf[index++] = 0x02;
                              sendBuf[index++] = buf[2];
                              sendBuf[index++] = test_vol;
                              for (i = 0; i < (sendBuf[1] + 1); i++) {
C51 COMPILER V9.56.0.0   APP_2D4                                                           11/11/2017 19:30:51 PAGE 6   

                                      sendBuf[index] += sendBuf[i + 1];
                              }
              #else
 305   2                      app_uart_send(KEY_VOL_MINUS_CMD, 0, 0);
 306   2      #endif
 307   2                      break;
 308   2              case KEY_PLAY_SHORT_CMD:
 309   2      
 310   2      #if 0
                              if (g_tWork.status.bits.DOME) {
                                      if (g_tWork.status.bits.pause) {
                                              g_tWork.status.bits.pause = 0;
                                              app_dome_start_current();
                                      } else {
                                              g_tWork.status.bits.pause = 1;
                                              app_dome_stop_current();
                                      }
              
                                      sendBuf[index++] = LAMP2LCD_HEADER;
                                      sendBuf[index++] = 11;
                                      sendBuf[index++] = KEY_PLAY_SHORT_CMD;
                                      sendBuf[index++] = 0x05;
                                      sendBuf[index++] = g_tWork.status.bits.pause;
                                      app_dome_get_current_Name(sendBuf + index, 8);
                                      index += 8;
                                      for (i = 0; i < (sendBuf[1] + 1); i++) {
                                              sendBuf[index] += sendBuf[i + 1];
                                      }
                                      index++;
                                      app_2d4_send(sendBuf, index);
              
                              } else {
              #endif
 335   2                      app_uart_send(KEY_PLAY_SHORT_CMD, 0, 0);
 336   2      //              }
 337   2      
 338   2                      break;
 339   2              case KEY_MODE_CMD:
 340   2      #if 0
                              if (buf[3] == 1) {
                                      switch (g_tWork.mode) {
                                              case 'B':
                                              g_tWork.mode = 'F';
                                              break;
                                              case 'F':
                                              g_tWork.mode = 'A';
                                              break;
                                              case 'A':
                                              g_tWork.mode = 'U';
                                              break;
                                              case 'U':
                                              g_tWork.mode = 'B';
                                              break;
                                      }
                              }
              
                              sendBuf[index++] = LAMP2LCD_HEADER;
                              sendBuf[index++] = 0x02;
                              sendBuf[index++] = buf[2];
                              sendBuf[index++] = g_tWork.mode;
                              for (i = 0; i < (sendBuf[1] + 1); i++) {
                                      sendBuf[index] += sendBuf[i + 1];
C51 COMPILER V9.56.0.0   APP_2D4                                                           11/11/2017 19:30:51 PAGE 7   

                              }
              #else
 366   2                      app_uart_send(KEY_MODE_CMD, 0, 0);
 367   2      #endif
 368   2      
 369   2                      break;
 370   2              }
 371   1              if (index) {
 372   2                      index++;
 373   2      #if 0
                              nop
                              nop
                              nop
                              nop
              
                              RF_TxMode();
                              sendRcv_flag = 1;
                              for (i = 0; i < 120; i++) {
                                      nop
                                      nop
                                      nop
                                      nop
                              }
              #else
 388   2                      app_2d4_send(sendBuf, index);
 389   2      #endif
 390   2              }
 391   1      
 392   1      }
 393          
 394          void app_2d4_pro(void) {
 395   1      
 396   1              if (sendRcv_flag) {
 397   2      
 398   2                      switch (ucRF_GetStatus()) {
 399   3                      case TX_DS_FLAG:                // 普通型发送完成 或 增强型发送成功
 400   3      
 401   3                              RF_ClearFIFO();
 402   3                              RF_ClearStatus();
 403   3      
 404   3      //                      printf("Send OK\r\n");
 405   3      
 406   3                              sendRcv_flag = 0;
 407   3                              RF_RxMode();
 408   3      
 409   3      //                      Relay_toggle();
 410   3      
 411   3                              break;
 412   3                      case RX_DR_FLAG:                //发送成功且收到payload
 413   3      
 414   3                              RF_ClearFIFO();
 415   3                              RF_ClearStatus();
 416   3                              break;
 417   3                      case MAX_RT_FLAG:               // 增强型发送超时失败
 418   3      
 419   3                              RF_ClearFIFO();
 420   3                              RF_ClearStatus();
 421   3                              break;
 422   3                      default:                // rf 处于空闲状态才发送数据
 423   3      
 424   3                              RF_TxData(sendBuf, sizeof(sendBuf));
 425   3      
C51 COMPILER V9.56.0.0   APP_2D4                                                           11/11/2017 19:30:51 PAGE 8   

 426   3                              break;
 427   3                      }
 428   2      
 429   2              } else {
 430   2                      if (ucRF_DumpRxData(rcvBuf, sizeof(rcvBuf))) {
 431   3                              app_2d4_Rcv(rcvBuf);
 432   3                      }
 433   2              }
 434   1      }
 435          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1689    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     41      11
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
